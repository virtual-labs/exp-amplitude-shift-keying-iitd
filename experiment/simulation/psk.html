<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Virtual Labs</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>
    <!-- sidebar and body -->
	<div id = "container">
    <h1>Instructions for Phase Shift Keying Modulation (PSK)</h1>
    <ul>
      <li class="step step4"><strong>Note:</strong> Use the input fields to enter the carrier frequency, sampling frequency, number of bits, and the bit rate.</li>
    
      <li class="step step1"><strong>Step 1:</strong> Click the <em>"Generate Message"</em> button to generate the input message signal.</li>
    
      <li class="step step2"><strong>Step 2:</strong> Click the <em>"Generate Carrier"</em> button to generate the carrier signal.</li>
    
      <li class="step step3"><strong>Step 3:</strong> Click the <em>"Simulate PSK"</em> button to generate the PSK signal.</li>
    
      <li class="step step4"><strong>Step 4:</strong> Click the <em>"Show Frequency Spectrums"</em> button to view the spectra of the PSK signal.</li>
    </ul>
<br/>
    <div class="flex min-h-[80vh]">
      <div class="px-6 pb-6 flex-1">
        <!--  -->
        <div class="flex">
          <div class="flex-1 basis-4/5 flex flex-col">
            <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <label
                    for="carrier_frequency"
                    class="text-[#2c99ce] font-medium"
                    >Carrier Frequency in Hz:</label
                  >
                  <input
                    class="border ml-5 border-black px-2 py-1 rounded-sm"
                    type="number"
                    id="carrier_frequency"
                    value="20"
                  />
                </div>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <label for="phaseshift" class="text-[#2c99ce] font-medium"
                    ></label
                  >
                  <select
                    class="border border-black px-2 py-[3px] ml-6 rounded-sm"
                    id="phase_shift"
                  >
                    <option value="1">π</option>
                    <option value="π/2">π/2</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <label
                    for="sampling_frequency"
                    class="text-[#2c99ce] font-medium"
                    >Sampling Frequency in Hz:</label
                  >
                  <input
                    class="border border-black px-2 py-1 rounded-sm"
                    type="number"
                    id="sampling_frequency"
                    value="1000"
                  />
                </div>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2">
                  <label for="num_bits" class="text-[#2c99ce] font-medium"
                    >Number of Bits:</label
                  >
                  <input
                    class="border px-2 border-black py-1 rounded-sm"
                    type="number"
                    id="num_bits"
                    value="5"
                  />
                </div>
              </div>
			  <div class="flex-1">
  <div class="flex items-center gap-2">
    <label for="bit_rate" class="text-[#2c99ce] font-medium">Bit Rate (bps):</label>
    <input
      class="border px-2 border-black py-1 rounded-sm"
      type="number"
      id="bit_rate"
      value="10"
    />
  </div>
</div>

            </div>
          </div>
          <div class="flex-1 flex flex-col basis-1/5">
            <div class="flex justify-center pt-4">


              </a>
            </div>
            <div class="flex justify-center pt-4">


              </a>
            </div>
          </div>
        </div>
        <div class="mt-4 border-t-2">
          <div class="flex flex-col">

            <div class="flex gap-2">
              <div class="flex-1 flex flex-col items-start">
                <div class="w-[550px]">
                  <img
                    class="w-[100%] h-[100%]"
                    src=".././images/simulation/psk_mod.png"
                    alt="psk_mod"
                  />
                </div>
				<!/div>
<!-- Vertical stack -->
<div class="flex flex-col items-center pt-4">
    <button class="bg-blue-500 text-white rounded-md px-2 py-1 mb-2" onclick="generateMessageSignal()">
        Generate Message
    </button>
    <button class="bg-blue-500 text-white rounded-md px-2 py-1 mb-2" onclick="generateCarrierSignal()">
        Generate Carrier
    </button>
    <button class="bg-blue-500 text-white rounded-md px-2 py-1 mb-2" onclick="generatePSKModulatedSignal()">
        Simulate PSK
    </button>
    <button
    class="bg-gray-500 text-white rounded-md px-2 py-1"
      onclick="generateSpectrumPSK()"
    >
      Show Frequency Spectrums
    </button>
</div>
              </div>
              <div class="flex flex-1 flex-col justify-center items-center">
			  <div class="max-h-[400px]" id="modulated-plot"></div>
			  <div class="max-h-[400px]" id="carrier-plot"></div>
                <div class="max-h-[400px]" id="original"></div>
                <div class="max-h-[400px]" id="frequencySpectrum"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
	
	<div id = "demodulation">
	<br/><br/><hr/>
	    <!-- sidebar and body -->
			  <div id = "container">
    <h1>Instructions for Phase Shift Keying (PSK) Demodulation</h1>
    <ul>
		<li class="step step1">Step 1: You can Demodulate the FSK Signal clicking on the 'Demodulate PSK' button</li>
		<li class="step step2">Step 2: Click on the 'Generate BER vs SNR' button to plot BER vs SNR graph</li>
		<li class="step step3">Step 3: Click on the 'Generate Constellation' button to see the constellation diagram for the same</li>
    </ul>
</div>
    <div class="flex min-h-[80vh]">
      <div class="px-6 pb-6 flex-1">
        <!--  -->
        <div class="flex">
          <div class="flex-1 basis-4/5 flex flex-col">
            <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">


            </div>
            <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
 

            </div>
          </div>
          <div class="flex-1 flex flex-col basis-1/5">
            <div class="flex justify-center pt-4">
              <a href="../bervssnr/PSK_BervsSnr.html">
                <button class="bg-blue-500 text-white rounded-md px-5 py-1">
                  Generate BERvsSNR
                </button>
              </a>
            </div>
            <div class="flex justify-center pt-4">
              <a href="../constellation/psk_constellation.html">
                <button class="bg-blue-500 text-white rounded-md px-2 py-1">
                  Generate Constellation
                </button>
              </a>
            </div>
          </div>
        </div>
        <div class="mt-4 border-t-2">
          <div class="flex flex-col">
            <div class="flex justify-center pt-4">
              <button
                class="bg-blue-500 text-white rounded-md px-2 py-1"
                class="button"
                onclick="demodulateSignal()"
              >
                Demodulate PSK
              </button>
            </div>
            <div class="flex gap-1">
              <div class="flex-1 flex flex-col items-center">
                <div class="w-full">
                  <img
                    class="w-[100%] h-[100%]"
                    src=".././images/simulation/psk_demod2.png"
                    alt="psk1"
                  />
                </div>
              </div>
              <div class="flex flex-1 flex-col justify-center items-center">
                <div class="max-h-[400px]" id="demodulated-plot"></div>
              </div>
            </div>
          </div>
        </div>
        <!--  -->
      </div>
    </div>
	
	</div>
 
     <script>
        function checkFrequencies() {
            // Get values from input fields
            let carrierFrequency = parseFloat(document.getElementById('carrier_frequency').value);
            let bit_rate = parseFloat(document.getElementById('bit_rate').value);
            
            // Check the frequencies
            if (carrierFrequency <= bit_rate) {
                alert("Carrier frequency should be much higher than bit rate.");
		    window.location.reload(true); 
            } else {
                console.log("Carrier frequency should be much high than bit rate.");
            }
        }

        // Function to attach event listeners to all buttons
        function attachEventListeners() {
            let buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('click', checkFrequencies);
            });
        }

        // Attach event listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', attachEventListeners);

    </script>
	
    <script>
        let bits = [];
        let modulated_signal = [];
        let Fs = 0;
        let fc = 0;
        let num_bits = 0;
        let phase_shift_value = 0;

        function generateMessageSignal() {
            num_bits = parseInt(document.getElementById("num_bits").value);

            // Generate random bits
            bits = Array.from({ length: num_bits }, () => Math.round(Math.random()));

            // Representation of transmitting binary information as a digital signal
            const { bitx, tx } = representDigitalSignal(bits);

            // Plot original signal
            const originalData = [{
                x: tx,
                y: bitx.flat(),
                type: "scatter",
                mode: "lines",
                name: "Binary Information at Transmitter",
            }];

            const originalLayout = {
                title: "Binary Information at Transmitter",
                xaxis: { title: "Time (s)" },
                yaxis: { title: "Bit Value" },
            };

            Plotly.newPlot("original", originalData, originalLayout);
        }

        function generateCarrierSignal() {
            Fs = parseInt(document.getElementById("sampling_frequency").value);
            fc = parseInt(document.getElementById("carrier_frequency").value);
            const t = Array.from({ length: 1 * Fs }, (_, i) => i / Fs);
            const carrier_signal = t.map((time) => Math.sin(2 * Math.PI * fc * time));

            const carrierData = [{
                x: t,
                y: carrier_signal,
                type: "scatter",
                mode: "lines",
                name: "Carrier Signal",
            }];

            const carrierLayout = {
                title: "Carrier Signal",
                xaxis: { title: "Time (s)" },
                yaxis: { title: "Amplitude" },
            };

            Plotly.newPlot("carrier-plot", carrierData, carrierLayout);
        }

        function generatePSKModulatedSignal() {
            Fs = parseInt(document.getElementById("sampling_frequency").value);
            fc = parseInt(document.getElementById("carrier_frequency").value);
			bit_rate = parseInt(document.getElementById("bit_rate").value);
            num_bits = parseInt(document.getElementById("num_bits").value);
            phase_shift_value = parseFloat(document.getElementById("phase_shift").value);

            // PSK modulation
            const t = Array.from({ length: Math.floor(Fs) }, (_, i) => i / Fs);
            modulated_signal = [];
            const phase_shift = Math.PI * phase_shift_value;

            for (const bit of bits) {
                const phase = bit === 0 ? 0 : phase_shift;
                const signal = t.map((time) => Math.sin(2 * Math.PI * fc * time + phase));
                modulated_signal = modulated_signal.concat(signal);
            }

            // Plot modulated signal
            const modulatedData = [{
                x: Array.from({ length: modulated_signal.length }, (_, i) => (i / Fs)/bit_rate),
                y: modulated_signal,
                type: "scatter",
                mode: "lines",
                name: "Modulated Signal",
            }];

            const modulatedLayout = {
                title: "PSK Modulated Signal",
                xaxis: { title: "Time (s)" },
                yaxis: { title: "Amplitude" },
            };

            Plotly.newPlot("modulated-plot", modulatedData, modulatedLayout);
			
			saveData();
        }

       function demodulateSignal() {
    // Ensure the modulated signal has been generated
    if (modulated_signal.length === 0) {
        alert("Please generate the modulated signal first.");
	    window.location.reload(true); 
        return;
    }

    const demodulated_signal = [];
    const t = Array.from({ length: Math.floor(Fs) }, (_, i) => i / Fs);

    for (let i = 0; i < num_bits; i++) {
        const startIndex = i * Math.floor(Fs);
        const segment = modulated_signal.slice(startIndex, startIndex + Math.floor(Fs));

        // Compute correlation with reference signal (sinusoid with 0 phase)
        const reference_signal = t.map((time) => Math.sin(2 * Math.PI * fc * time));
        const correlation = segment.reduce((acc, val, index) => acc + val * reference_signal[index], 0);

        // If correlation is positive, demodulate as bit 0; otherwise, demodulate as bit 1
        demodulated_signal.push(correlation < 0 ? 1 : 0);
    }

    const bits2 = demodulated_signal;

    // Representation of transmitting binary information as a digital signal
    const { bitx: bitx2, tx: tx2 } = representDigitalSignal(bits2);

    // Plot demodulated signal
    const demodulatedData = [{
        x: tx2,
        y: bitx2.flat(),
        type: "scatter",
        mode: "lines",
        name: "Demodulated Signal",
    }];
    const demodulatedLayout = {
        title: "Demodulated Bits",
        xaxis: { title: "Time (s)" },
        yaxis: { title: "Bit Value" },
    };

    Plotly.newPlot("demodulated-plot", demodulatedData, demodulatedLayout);
}

        function representDigitalSignal(bitsx) {
            const bitx = [];
            const Fs = parseInt(document.getElementById("sampling_frequency").value);
			const bps = parseInt(document.getElementById("bit_rate").value);
            const bp = 1/bps; // Bit period

            // Represent each bit as a sequence of 0s or 1s
            for (let n = 0; n < bitsx.length; n++) {
                bitx.push(Array(Fs).fill(bitsx[n]));
            }

            const tx = [];
            for (let i = 1; i <= Fs * bitsx.length; i++) {
                tx.push((i * bp) / Fs);
            }

            return { bitx, tx };
        }

        //const fs = 1000;
    let Tb;
   //let fc;
    function sinc(x) {
      return x === 0 ? 1 : Math.sin(Math.PI * x) / (Math.PI * x);
    }

    function generateSpectrum(centerFreqs, label, color) {
      const f = Array.from({ length: 1000 }, (_, i) => -150 + i * 0.3);
      const y = f.map(freq => {
        return centerFreqs.reduce((acc, fc) => acc + Math.abs(sinc((freq - fc) * Tb)), 0);
      });
      return {
        x: f,
        y: y,
        name: label,
        line: { color },
        mode: 'lines'
      };
    }

    function generateSpectrumPSK() {
    Tb = 1/parseInt(document.getElementById("bit_rate").value);//1/bitRate;
    console.log(Tb);
    let A = 1;
    fc = parseInt(document.getElementById("carrier_frequency").value);;
    let deltaF = 5;
    const askSpec = generateSpectrum([fc, -fc], 'ASK Spectrum', 'red');
    const fskSpec = generateSpectrum([fc + deltaF, fc - deltaF, -(fc + deltaF), -(fc - deltaF)], 'FSK Spectrum', 'blue');
    const pskSpec = generateSpectrum([fc, -fc], 'PSK Spectrum', 'green');

    Plotly.newPlot('frequencySpectrum', [pskSpec], {
      title: 'Spectra of PSK',
      xaxis: { title: 'Frequency (Hz)' },
      yaxis: { title: 'Amplitude', rangemode: 'tozero' }
    });
    document.getElementById('frequencySpectrum').scrollIntoView({ behavior: 'smooth' });
  }
	
	
	function saveData() {
  const Fs = parseFloat(document.getElementById('sampling_frequency').value);
  const fc = parseFloat(document.getElementById('carrier_frequency').value);
  const num_bits = parseFloat(document.getElementById('num_bits').value);
 const bit_rate = parseFloat(document.getElementById('bit_rate').value);

  // Store as an object (use the variables you actually defined)
  const myData = { Fs: Fs, fc: fc, num_bits: num_bits, bit_rate: bit_rate, bits: bits };

  localStorage.setItem('sharedData', JSON.stringify(myData));
}
    </script>
	
	
	<style>
	#demodulation {
	display: none;
	}
	#phase_shift {
	display: none;
	}
  #container {
  background-color: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 12px;
  padding: 25px 40px;
  max-width: 100%;
  margin: 20px auto;
  text-align: left;
  font-family: 'Segoe UI', sans-serif;
}

h1 {
  color: #1e3a8a;
  font-size: 24px;
  margin-bottom: 25px;
  text-align: justify;
}

ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

li.step {
  margin: 12px 0;
  padding: 12px 15px;
  border-radius: 6px;
  font-size: 18px;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, background-color 0.2s ease;
}

li.step::before {
  content: "✔";
  color: #10b981;
  margin-right: 10px;
  font-weight: bold;
}

li.step:hover {
  transform: scale(1.02);
  background-color: #f3f4f6;
}

/* Color code each step */
.step1 {
  background-color: #ffe0e0;
  border-left: 5px solid #ef4444;
}
.step2 {
  background-color: #e0f7ff;
  border-left: 5px solid #0ea5e9;
}
.step3 {
  background-color: #e0ffe5;
  border-left: 5px solid #22c55e;
}
.step4 {
  background-color: #f5e0ff;
  border-left: 5px solid #a855f7;
}
	</style>
	
  </body>
</html>
