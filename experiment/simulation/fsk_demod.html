<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Virtual Labs</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id = "modulation">
<div id = "container">
    <h1>Instructions for Frequency Shift Keying Modulation (FSK)</h1>
    <ul>
        <li class="step step1">Step 1: Click on 'Generate Message' button to generate input message signal</li>
        <li class="step step2">Step 2: Then click on 'Generate Carrier' button to generate carrier signal</li>
		<li class="step step3">Step 3: You can change the carrier signal frequencies from the input fields</li>
        <li class="step step4">Step 4: Click on 'Simulate FSK' button to generate Frequency Shift Keying Signal</li>
    </ul>
<br/>
    <!-- sidebar and body -->
    <div class="flex min-h-[80vh]">
        <div class="px-6 pb-6 flex-1">
            <div class="flex">
                <div class="flex-1 basis-3/4 flex flex-col">
                    <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="carrier_frequency1" class="text-[#2c99ce] font-medium">Carrier Frequency 1 in Hz:</label>
                                <input class="border ml-2 border-black px-2 py-1 rounded-sm" type="number" id="carrier_frequency1" value="20" />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="carrier_frequency2" class="text-[#2c99ce] font-medium">Carrier Frequency 2 in Hz:</label>
                                <input class="border border-black px-2 py-1 rounded-sm" type="number" id="carrier_frequency2" value="100" />
                            </div>
                        </div>
                    </div>
                    <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="sampling_frequency" class="text-[#2c99ce] font-medium">Sampling Frequency in Hz:</label>
                                <input class="border border-black px-2 py-1 rounded-sm" type="number" id="sampling_frequency" value="1000" />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="bit_rate" class="text-[#2c99ce] font-medium">Bit Rate (bps):</label>
                                <input class="border px-2 ml-[72px] border-black py-1 rounded-sm" type="number" id="bit_rate" value="10" />
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="mt-4 border-t-2">
                <div class="flex flex-col">
                    <div class="flex gap-1">
                        <div class="flex w-[50%] flex-col items-center">
                            <div class="relative my-4 w-[600px] h-[150px]">
                                <!-- buttons -->
                                <div class="absolute top-[102px] left-[0px]">
                                    <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="generateMessageSignal()">Generate Message</button>
                                </div>
                                <div class="absolute top-[130px] left-[184px]">
                                    <button class="bg-blue-500 text-sm text-white rounded-md px-2 py-1" class="button" onclick="generateCarrierSignal()">Generate Carrier 1</button>
                                </div>
                                <div class="absolute top-[165px] left-[184px]">
                                    <button class="bg-blue-500 text-sm text-white rounded-md px-2 py-1" class="button" onclick="generateCarrierSignal2()">Generate Carrier 2</button>
                                </div>
                                <div class="absolute top-[300px] left-[177px]">
                                    <button
                                      class="bg-gray-500 text-white rounded-md px-2 py-1"
                                      class="button"
                                      onclick="generateSpectrumFSK()"
                                    >
                                      Show Frequency Spectrums
                                    </button>
                                  </div>
                                <div class="absolute top-[132px] right-[75px]">
                                    <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="simulateFSK()">Simulate FSK</button>
                                </div>
                                <img class="w-[100%] h-[100%]" src=".././images/simulation/fskimg1.png" alt="fsk1" />
                            </div>
                        </div>
                        <div class="flex w-[50%] flex-col justify-center items-center">
                            <div id="modulated-plot"></div>
                            <div id="carrier-plot2"></div>
                            <div id="carrier-plot"></div>
                            <div id="original"></div>
                            <div id="frequencySpectrum"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <br /><br /><hr />
	</div></div>
	  <div id = "container">
    <h1>Instructions for Frequency Shift Keying (FSK) Demodulation</h1>
    <ul>
		<li class="step step1">Step 1: You can Demodulate the FSK Signal clicking on the 'Demodulate FSK' button</li>
		<li class="step step2">Step 2: Click on the 'Generate BER vs SNR' button to plot BER vs SNR graph</li>
		<li class="step step3">Step 3: Click on the 'Generate letellation' button to see the constellation diagram of FSK</li>
        <li class="step step4"><strong>Tip:</strong> FSK Modulation settings auto-transfer to the FSK Demodulation tab. No need to re-enter values. Keep both tabs open, or demodulate immediately after modulation.</li>
	</ul>
</div>	
    <!-- sidebar and body -->
    <div class="flex min-h-[80vh]">
        <div class="px-6 pb-6 flex-1">
            <!--  -->
            <div class="flex flex-col">
                <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                 <div class="flex-1 flex flex-col basis-1/4">
                    <div class="flex justify-end pt-4">
                        <a href="../bervssnr/FSK_BervsSnr.html">
                            <button class="bg-blue-500 text-white rounded-md px-4 py-1">Generate BERvsSNR</button>
                        </a>
                    </div>
                    <div class="flex justify-end pt-4">
                        <a href="../letellation/fsk_letellation.html">
                            <button class="bg-blue-500 text-white rounded-md px-2 py-1">Generate letellation</button>
                        </a>
                    </div>
                </div>
                </div>
            </div>
            <div class="mt-4 border-t-2">
                <div class="flex flex-col">
                    <div class="flex justify-center pt-4">
                        <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="demodulateFSK()">Demodulate FSK</button>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 flex flex-col items-center">
                            <div class="">
                                <button
                                onclick="FSKInput();"
                                class="bg-blue-500 text-white py-1 px-3 mt-1 rounded-md hover:bg-[#0c9c0c] hover:scale-105"
                              >
                                FSK Input
                              </button>
                                <img src=".././images/simulation/fskimg2.png" alt="fsk2" />
                            </div>
                        </div>
                        <div class="flex flex-1 flex-col justify-center items-center">
                            <div id="SSBSCInput1" class="flex gap-4">
                                <!-- Time-domain plot -->
                                <div id="FSKInput" class="flex-1  w-[50%]"></div>
                                <!-- Frequency-domain plot -->
                                <div id="frequencySpectrum1" class="flex-1  w-[50%]"></div>
                              </div>
                            <div id="demodulated-plot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
    function checkFrequencies() {
        // Get values from input fields
        let carrierFrequency1 = parseFloat(document.getElementById('carrier_frequency1').value);
        let carrierFrequency2 = parseFloat(document.getElementById('carrier_frequency2').value);
        let bitRate = parseFloat(document.getElementById('bit_rate').value);
        
        // Check the carrier frequency vs. bit rate
        if (carrierFrequency1 <= bitRate) {
            alert("Carrier frequency 1 should be much higher than bit rate.");
			window.location.reload(true); 
            return; // Exit if the condition is not met
        }

        // Check the second carrier frequency vs. the first carrier frequency
        if (carrierFrequency2 <= carrierFrequency1) {
            alert("Carrier frequency 2 should be higher than Carrier frequency 1.");
            window.location.reload(true); 
			return; // Exit if the condition is not met
        }

        // If all conditions are met
        console.log("Carrier frequency 1 is much higher than bit rate.");
        console.log("Carrier frequency 2 is higher than Carrier frequency 1.");
    }

    // Function to attach event listeners to all buttons
    function attachEventListeners() {
        let buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('click', checkFrequencies);
        });
    }

    // Attach event listeners when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', attachEventListeners);
</script>

	
<script>
    let isGenerated1 = false; // Flag to check if first carrier signal is generated
    let isGenerated2 = false; // Flag to check if second carrier signal is generated
    let bits, modulated_signal;

    function generateCarrierSignal() {
        let carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Hz
        let samplingFrequency = parseInt(document.getElementById("sampling_frequency").value); // Hz
        let durationInSeconds = 1; // Duration of 1 second

        let numSamples = Math.floor(samplingFrequency * durationInSeconds);
        let t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        let carrierSignal = t.map((time) => Math.sin(2 * Math.PI * carrierFrequency * time));

        // Plot carrier signal 1
        let traceCarrier1 = {
            x: t,
            y: carrierSignal,
            mode: "lines",
            name: "Carrier Signal 1",
        };

        let layoutCarrier1 = {
            title: "Carrier Signal 1",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("carrier-plot", [traceCarrier1], layoutCarrier1);
        isGenerated1 = true;
    }

    function generateCarrierSignal2() {
        let carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Hz
        let samplingFrequency2 = parseInt(document.getElementById("sampling_frequency").value); // Hz
        let durationInSeconds = 1; // Duration of 1 second

        let numSamples2 = Math.floor(samplingFrequency2 * durationInSeconds);
        let t2 = Array.from({ length: numSamples2 }, (_, i) => i / samplingFrequency2);

        let carrierSignal2 = t2.map((time) => Math.sin(2 * Math.PI * carrierFrequency2 * time));

        // Plot carrier signal 2
        let traceCarrier2 = {
            x: t2,
            y: carrierSignal2,
            mode: "lines",
            name: "Carrier Signal 2",
        };

        let layoutCarrier2 = {
            title: "Carrier Signal 2",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("carrier-plot2", [traceCarrier2], layoutCarrier2);
        isGenerated2 = true;
    }

    function generateMessageSignal() {
        let samplingFrequency = parseInt(document.getElementById("sampling_frequency").value);
        let bitRate = parseInt(document.getElementById("bit_rate").value);
        let durationInSeconds = 1; // Duration of 1 second
        let numBits = Math.floor(durationInSeconds * bitRate);

        // Generate random bits (0 or 1)
        bits = Array.from({ length: numBits }, () => Math.round(Math.random()));

        // Convert bits to time-domain signal
        let numSamplesPerBit = Math.floor(samplingFrequency / bitRate);
        let messageSignal = bits.flatMap((bit) =>
            Array.from({ length: numSamplesPerBit }, () => bit) // Amplitude of 1 for bit 1, and 0 for bit 0
        );

        let numSamples = messageSignal.length;
        let t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        // Plot message signal
        let traceMessage = {
            x: t,
            y: messageSignal,
            mode: "lines",
            name: "Message Signal",
            text: bits.map((bit, index) => ({
                x: (index + 0.5) * (1 / bitRate),
                y: 1.1, // Adjust text position above the plot
                text: bit.toString(),
                showarrow: false,
                font: { size: 12, color: bit === 1 ? 'green' : 'red' },
            })),
            textposition: 'top center',
        };

        let layoutMessage = {
            title: "Message Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("original", [traceMessage], layoutMessage);
    }

    function simulateFSK() {
        if (!isGenerated1 || !isGenerated2) {
            alert("Please generate both carrier signals first.");
			window.location.reload(true); 
            return;
        }

        let carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Hz
        let carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Hz
        let samplingFrequency = parseInt(document.getElementById("sampling_frequency").value); // Hz
        let bitRate = parseInt(document.getElementById("bit_rate").value);

        let durationInSeconds = 1; // Duration of 1 second
        let numSamples = Math.floor(samplingFrequency * durationInSeconds);
        let t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        let numSamplesPerBit = Math.floor(samplingFrequency / bitRate);

        modulated_signal = [];

        for (let i = 0; i < bits.length; i++) {
            let carrierFrequencyToUse = bits[i] === 1 ? carrierFrequency : carrierFrequency2;
            for (let j = 0; j < numSamplesPerBit; j++) {
                let timeIndex = i * numSamplesPerBit + j;
                modulated_signal.push(
                    Math.sin(2 * Math.PI * carrierFrequencyToUse * t[timeIndex])
                );
            }
        }

        let traceModulated = {
            x: t,
            y: modulated_signal,
            mode: "lines",
            name: "Modulated Signal",
        };

        let layoutModulated = {
            title: "FSK Modulated Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("modulated-plot", [traceModulated], layoutModulated);
    }

    function demodulateFSK() {
	generateCarrierSignal();
	generateCarrierSignal2();
        if (!modulated_signal || modulated_signal.length === 0) {
            alert("Please simulate FSK modulation first.");
			window.location.reload(true); 
            return;
        }

        let samplingFrequency = parseInt(document.getElementById("sampling_frequency").value);
        let bitRate = parseInt(document.getElementById("bit_rate").value);
        let carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Retrieve carrier frequency
        let carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Retrieve carrier frequency 2
        let numSamplesPerBit = Math.floor(samplingFrequency / bitRate);
        let numBits = Math.floor(modulated_signal.length / numSamplesPerBit);
        let demodulated_bits = [];

        for (let i = 0; i < numBits; i++) {
            let sum1 = 0;
            let sum2 = 0;

            for (let j = 0; j < numSamplesPerBit; j++) {
                let timeIndex = i * numSamplesPerBit + j;
                sum1 += modulated_signal[timeIndex] * Math.sin(2 * Math.PI * carrierFrequency * timeIndex / samplingFrequency);
                sum2 += modulated_signal[timeIndex] * Math.sin(2 * Math.PI * carrierFrequency2 * timeIndex / samplingFrequency);
            }

            if (sum1 > sum2) {
                demodulated_bits.push(1);
            } else {
                demodulated_bits.push(0);
            }
        }

        // Convert demodulated bits back to time-domain signal
        let demodulatedSignal = demodulated_bits.flatMap((bit) =>
            Array.from({ length: numSamplesPerBit }, () => bit) // Amplitude of 1 for bit 1, and 0 for bit 0
        );

        let numSamples = demodulatedSignal.length;
        let t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        // Plot demodulated signal
        let traceDemodulated = {
            x: t,
            y: demodulatedSignal,
            mode: "lines",
            name: "Demodulated Signal",
            text: demodulated_bits.map((bit, index) => ({
                x: (index + 0.5) * (1 / bitRate),
                y: 1.1, // Adjust text position above the plot
                text: bit.toString(),
                showarrow: false,
                font: { size: 12, color: bit === 1 ? 'green' : 'red' },
            })),
            textposition: 'top center',
        };

        let layoutDemodulated = {
            title: "FSK Demodulated Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("demodulated-plot", [traceDemodulated], layoutDemodulated);
    }


//let fs = 1000;
let Tb;
   let fc1, fc2;
    function sinc(x) {
      return x === 0 ? 1 : Math.sin(Math.PI * x) / (Math.PI * x);
    }

    function generateSpectrum(centerFreqs, label, color) {
      let f = Array.from({ length: 1000 }, (_, i) => -150 + i * 0.3);
      let y = f.map(freq => {
        return centerFreqs.reduce((acc, fc) => acc + Math.abs(sinc((freq - fc) * Tb)), 0);
      });
      return {
        x: f,
        y: y,
        name: label,
        line: { color },
        mode: 'lines'
      };
    }

    function generateSpectrumFSK() {
    Tb = 1/parseInt(document.getElementById("bit_rate").value);//1/bitRate;
    console.log(Tb);
    let A = 1;
    fc1 = parseInt(document.getElementById("carrier_frequency1").value);
    fc2 = parseInt(document.getElementById("carrier_frequency2").value);
    let fskSpec = generateSpectrum([fc1, fc2, -fc1, -fc2], 'FSK Spectrum', 'blue');

    Plotly.newPlot('frequencySpectrum1', [fskSpec], {
      title: 'Spectra of FSK',
      xaxis: { title: 'Frequency (Hz)' },
      yaxis: { title: 'Amplitude', rangemode: 'tozero' }
    });
    document.getElementById('frequencySpectrum1').scrollIntoView({ behavior: 'smooth' });
  }
  


  function FSKInput() {
    if (!modulated_signal) {
            alert("Please perform FM modulation first!");
			window.location.reload(true); 
            return;
        }

        let carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Hz
        let carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Hz
        let samplingFrequency = parseInt(document.getElementById("sampling_frequency").value); // Hz
        let bitRate = parseInt(document.getElementById("bit_rate").value);

        let durationInSeconds = 1; // Duration of 1 second
        let numSamples = Math.floor(samplingFrequency * durationInSeconds);
        let t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);


        let traceModulated = {
            x: t,
            y: modulated_signal,
            mode: "lines",
            name: "Modulated Signal",
        };

        let layoutModulated = {
            title: "FSK Modulated Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("FSKInput", [traceModulated], layoutModulated);
  generateSpectrumFSK();
}

function loadData() {
  const data = localStorage.getItem('sharedData');
  if (data) {
    const parsed = JSON.parse(data);

    // Update input fields in current tab
    document.getElementById('sampling_frequency').value = parsed.samplingFrequency ?? '';
    document.getElementById('carrier_frequency1').value = parsed.carrierFrequency ?? '';
    document.getElementById('carrier_frequency2').value = parsed.carrierFrequency2 ?? '';
    document.getElementById('bit_rate').value = parsed.bitRate ?? '';

    modulated_signal = parsed.modulated_signal ?? null; 
  }
}

// Load immediately
loadData();

// Update if storage changes (works across tabs)
window.addEventListener('storage', loadData);
</script>

  <style>
  #modulation {
  display: none;
  }
#container {
  background-color: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 12px;
  padding: 25px 40px;
  max-width: 100%;
  margin: 20px auto;
  text-align: left;
  font-family: 'Segoe UI', sans-serif;
}

h1 {
  color: #1e3a8a;
  font-size: 24px;
  margin-bottom: 25px;
  text-align: justify;
}

ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

li.step {
  margin: 12px 0;
  padding: 12px 15px;
  border-radius: 6px;
  font-size: 18px;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, background-color 0.2s ease;
}

li.step::before {
  content: "✔";
  color: #10b981;
  margin-right: 10px;
  font-weight: bold;
}

li.step:hover {
  transform: scale(1.02);
  background-color: #f3f4f6;
}

/* Color code each step */
.step1 {
  background-color: #ffe0e0;
  border-left: 5px solid #ef4444;
}
.step2 {
  background-color: #e0f7ff;
  border-left: 5px solid #0ea5e9;
}
.step3 {
  background-color: #e0ffe5;
  border-left: 5px solid #22c55e;
}
.step4 {
  background-color: #f5e0ff;
  border-left: 5px solid #a855f7;
}
  </style>
  
</body>
</html>
