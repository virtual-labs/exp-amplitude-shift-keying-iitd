<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Virtual Labs</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<div id = "container">
    <h1>Instructions for Frequency Shift Keying Modulation (FSK)</h1>
		    <ul>
      <li class="step step4"><strong>Note:</strong> Use the input fields to enter the carrier frequencies, sampling frequency, and the bit rate.</li>
    
      <li class="step step1"><strong>Step 1:</strong> Click on <em>'Generate Message'</em> button to generate input message signal.</li>
    
      <li class="step step2"><strong>Step 2:</strong> Then click on <em>'Generate Carrier'</em> button to generate carrier signal. </li>
    
      <li class="step step3"><strong>Step 3:</strong> Click on <em>'Simulate FSK'</em> button to generate Frequency Shift Keying Signal.</li>
    
      <li class="step step4"><strong>Step 4:</strong> Click the <em>"Show Frequency Spectrums"</em> button to view the spectra of the FSK signal.</li>
    </ul>
<br/>
    <!-- sidebar and body -->
    <div class="flex min-h-[80vh]">
        <div class="px-6 pb-6 flex-1">
            <div class="flex">
                <div class="flex-1 basis-3/4 flex flex-col">
                    <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="carrier_frequency1" class="text-[#2c99ce] font-medium">Carrier Frequency 1 in Hz:</label>
                                <input class="border ml-2 border-black px-2 py-1 rounded-sm" type="number" id="carrier_frequency1" value="20" />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="carrier_frequency2" class="text-[#2c99ce] font-medium">Carrier Frequency 2 in Hz:</label>
                                <input class="border border-black px-2 py-1 rounded-sm" type="number" id="carrier_frequency2" value="100" />
                            </div>
                        </div>
                    </div>
                    <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="sampling_frequency" class="text-[#2c99ce] font-medium">Sampling Frequency in Hz:</label>
                                <input class="border border-black px-2 py-1 rounded-sm" type="number" id="sampling_frequency" value="1000" />
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <label for="bit_rate" class="text-[#2c99ce] font-medium">Bit Rate (bps):</label>
                                <input class="border px-2 ml-[72px] border-black py-1 rounded-sm" type="number" id="bit_rate" value="10" />
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="mt-4 border-t-2">
                <div class="flex flex-col">
                    <div class="flex gap-1">
                        <div class="flex w-[50%] flex-col items-center">
                            <div class="relative my-4 w-[600px] h-[150px]">
                                <!-- buttons -->
                                <div class="absolute top-[102px] left-[0px]">
                                    <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="generateMessageSignal()">Generate Message</button>
                                </div>
                                <div class="absolute top-[130px] left-[184px]">
                                    <button class="bg-blue-500 text-sm text-white rounded-md px-2 py-1" class="button" onclick="generateCarrierSignal()">Generate Carrier 1</button>
                                </div>
                                <div class="absolute top-[165px] left-[184px]">
                                    <button class="bg-blue-500 text-sm text-white rounded-md px-2 py-1" class="button" onclick="generateCarrierSignal2()">Generate Carrier 2</button>
                                </div>
                                <div class="absolute top-[300px] left-[177px]">
                                    <button
                                      class="bg-gray-500 text-white rounded-md px-2 py-1"
                                      class="button"
                                      onclick="generateSpectrumFSK()"
                                    >
                                      Show Frequency Spectrums
                                    </button>
                                  </div>
                                <div class="absolute top-[132px] right-[75px]">
                                    <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="simulateFSK()">Simulate FSK</button>
                                </div>
                                <img class="w-[100%] h-[100%]" src=".././images/simulation/fskimg1.png" alt="fsk1" />
                            </div>
                        </div>
                        <div class="flex w-[50%] flex-col justify-center items-center">
                            <div id="modulated-plot"></div>
                            <div id="carrier-plot2"></div>
                            <div id="carrier-plot"></div>
                            <div id="original"></div>
                            <div id="frequencySpectrum"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<div id = "demodulation">
    <br /><br /><hr />

	  <div id = "container">
    <h1>Instructions for Frequency Shift Keying (FSK) Demodulation</h1>
    <ul>
		<li class="step step1">Step 1: You can Demodulate the FSK Signal clicking on the 'Demodulate FSK' button</li>
		<li class="step step2">Step 2: Click on the 'Generate BER vs SNR' button to plot BER vs SNR graph</li>
		<li class="step step3">Step 3: Click on the 'Generate Constellation' button to see the constellation diagram for the same</li>
    </ul>
</div>	
    <!-- sidebar and body -->
    <div class="flex min-h-[80vh]">
        <div class="px-6 pb-6 flex-1">
            <!--  -->
            <div class="flex flex-col">
                <div class="flex max-lg:flex-col mt-5 items-center gap-x-8 gap-y-2">
                 <div class="flex-1 flex flex-col basis-1/4">
                    <div class="flex justify-end pt-4">
                        <a href="../bervssnr/FSK_BervsSnr.html">
                            <button class="bg-blue-500 text-white rounded-md px-4 py-1">Generate BERvsSNR</button>
                        </a>
                    </div>
                    <div class="flex justify-end pt-4">
                        <a href="../constellation/fsk_constellation.html">
                            <button class="bg-blue-500 text-white rounded-md px-2 py-1">Generate Constellation</button>
                        </a>
                    </div>
                </div>
                </div>
            </div>
            <div class="mt-4 border-t-2">
                <div class="flex flex-col">
                    <div class="flex justify-center pt-4">
                        <button class="bg-blue-500 text-white rounded-md px-2 py-1" class="button" onclick="demodulateFSK()">Demodulate FSK</button>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex-1 flex flex-col items-center">
                            <div class="">
                                <img src=".././images/simulation/fskimg2.png" alt="fsk2" />
                            </div>
                        </div>
                        <div class="flex flex-1 flex-col justify-center items-center">
                            <div id="demodulated-plot"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function checkFrequencies() {
        // Get values from input fields
        let carrierFrequency1 = parseFloat(document.getElementById('carrier_frequency1').value);
        let carrierFrequency2 = parseFloat(document.getElementById('carrier_frequency2').value);
        let bitRate = parseFloat(document.getElementById('bit_rate').value);
        
        // Check the carrier frequency vs. bit rate
        if (carrierFrequency1 <= bitRate) {
            alert("Carrier frequency 1 should be much higher than bit rate.");
			window.location.reload(true); 
            return; // Exit if the condition is not met
        }

        // Check the second carrier frequency vs. the first carrier frequency
        if (carrierFrequency2 <= carrierFrequency1) {
            alert("Carrier frequency 2 should be higher than Carrier frequency 1.");
            window.location.reload(true); 
			return; // Exit if the condition is not met
        }

        // If all conditions are met
        console.log("Carrier frequency 1 is much higher than bit rate.");
        console.log("Carrier frequency 2 is higher than Carrier frequency 1.");
    }

    // Function to attach event listeners to all buttons
    function attachEventListeners() {
        let buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('click', checkFrequencies);
        });
    }

    // Attach event listeners when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', attachEventListeners);
</script>

	
<script>
    let isGenerated1 = false; // Flag to check if first carrier signal is generated
    let isGenerated2 = false; // Flag to check if second carrier signal is generated
    let bits, modulated_signal;

    function generateCarrierSignal() {
        const carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Hz
        const samplingFrequency = parseInt(document.getElementById("sampling_frequency").value); // Hz
        const durationInSeconds = 1; // Duration of 1 second

        const numSamples = Math.floor(samplingFrequency * durationInSeconds);
        const t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        const carrierSignal = t.map((time) => Math.sin(2 * Math.PI * carrierFrequency * time));

        // Plot carrier signal 1
        const traceCarrier1 = {
            x: t,
            y: carrierSignal,
            mode: "lines",
            name: "Carrier Signal 1",
        };

        const layoutCarrier1 = {
            title: "Carrier Signal 1",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("carrier-plot", [traceCarrier1], layoutCarrier1);
        isGenerated1 = true;
    }

    function generateCarrierSignal2() {
        const carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Hz
        const samplingFrequency2 = parseInt(document.getElementById("sampling_frequency").value); // Hz
        const durationInSeconds = 1; // Duration of 1 second

        const numSamples2 = Math.floor(samplingFrequency2 * durationInSeconds);
        const t2 = Array.from({ length: numSamples2 }, (_, i) => i / samplingFrequency2);

        const carrierSignal2 = t2.map((time) => Math.sin(2 * Math.PI * carrierFrequency2 * time));

        // Plot carrier signal 2
        const traceCarrier2 = {
            x: t2,
            y: carrierSignal2,
            mode: "lines",
            name: "Carrier Signal 2",
        };

        const layoutCarrier2 = {
            title: "Carrier Signal 2",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("carrier-plot2", [traceCarrier2], layoutCarrier2);
        isGenerated2 = true;
    }

    function generateMessageSignal() {
        const samplingFrequency = parseInt(document.getElementById("sampling_frequency").value);
        const bitRate = parseInt(document.getElementById("bit_rate").value);
        const durationInSeconds = 1; // Duration of 1 second
        const numBits = Math.floor(durationInSeconds * bitRate);

        // Generate random bits (0 or 1)
        bits = Array.from({ length: numBits }, () => Math.round(Math.random()));

        // Convert bits to time-domain signal
        const numSamplesPerBit = Math.floor(samplingFrequency / bitRate);
        const messageSignal = bits.flatMap((bit) =>
            Array.from({ length: numSamplesPerBit }, () => bit) // Amplitude of 1 for bit 1, and 0 for bit 0
        );

        const numSamples = messageSignal.length;
        const t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        // Plot message signal
        const traceMessage = {
            x: t,
            y: messageSignal,
            mode: "lines",
            name: "Message Signal",
            text: bits.map((bit, index) => ({
                x: (index + 0.5) * (1 / bitRate),
                y: 1.1, // Adjust text position above the plot
                text: bit.toString(),
                showarrow: false,
                font: { size: 12, color: bit === 1 ? 'green' : 'red' },
            })),
            textposition: 'top center',
        };

        const layoutMessage = {
            title: "Message Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("original", [traceMessage], layoutMessage);
    }

    function simulateFSK() {
        if (!isGenerated1 || !isGenerated2) {
            alert("Please generate both carrier signals first.");
			window.location.reload(true); 
            return;
        }

        const carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Hz
        const carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Hz
        const samplingFrequency = parseInt(document.getElementById("sampling_frequency").value); // Hz
        const bitRate = parseInt(document.getElementById("bit_rate").value);

        const durationInSeconds = 1; // Duration of 1 second
        const numSamples = Math.floor(samplingFrequency * durationInSeconds);
        const t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        const numSamplesPerBit = Math.floor(samplingFrequency / bitRate);

        modulated_signal = [];

        for (let i = 0; i < bits.length; i++) {
            const carrierFrequencyToUse = bits[i] === 1 ? carrierFrequency : carrierFrequency2;
            for (let j = 0; j < numSamplesPerBit; j++) {
                const timeIndex = i * numSamplesPerBit + j;
                modulated_signal.push(
                    Math.sin(2 * Math.PI * carrierFrequencyToUse * t[timeIndex])
                );
            }
        }

        const traceModulated = {
            x: t,
            y: modulated_signal,
            mode: "lines",
            name: "Modulated Signal",
        };

        const layoutModulated = {
            title: "FSK Modulated Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("modulated-plot", [traceModulated], layoutModulated);
		
		saveData();
    }

    function demodulateFSK() {
        if (!modulated_signal || modulated_signal.length === 0) {
            alert("Please simulate FSK modulation first.");
			window.location.reload(true); 
            return;
        }

        const samplingFrequency = parseInt(document.getElementById("sampling_frequency").value);
        const bitRate = parseInt(document.getElementById("bit_rate").value);
        const carrierFrequency = parseInt(document.getElementById("carrier_frequency1").value); // Retrieve carrier frequency
        const carrierFrequency2 = parseInt(document.getElementById("carrier_frequency2").value); // Retrieve carrier frequency 2
        const numSamplesPerBit = Math.floor(samplingFrequency / bitRate);
        const numBits = Math.floor(modulated_signal.length / numSamplesPerBit);
        const demodulated_bits = [];

        for (let i = 0; i < numBits; i++) {
            let sum1 = 0;
            let sum2 = 0;

            for (let j = 0; j < numSamplesPerBit; j++) {
                const timeIndex = i * numSamplesPerBit + j;
                sum1 += modulated_signal[timeIndex] * Math.sin(2 * Math.PI * carrierFrequency * timeIndex / samplingFrequency);
                sum2 += modulated_signal[timeIndex] * Math.sin(2 * Math.PI * carrierFrequency2 * timeIndex / samplingFrequency);
            }

            if (sum1 > sum2) {
                demodulated_bits.push(1);
            } else {
                demodulated_bits.push(0);
            }
        }

        // Convert demodulated bits back to time-domain signal
        const demodulatedSignal = demodulated_bits.flatMap((bit) =>
            Array.from({ length: numSamplesPerBit }, () => bit) // Amplitude of 1 for bit 1, and 0 for bit 0
        );

        const numSamples = demodulatedSignal.length;
        const t = Array.from({ length: numSamples }, (_, i) => i / samplingFrequency);

        // Plot demodulated signal
        const traceDemodulated = {
            x: t,
            y: demodulatedSignal,
            mode: "lines",
            name: "Demodulated Signal",
            text: demodulated_bits.map((bit, index) => ({
                x: (index + 0.5) * (1 / bitRate),
                y: 1.1, // Adjust text position above the plot
                text: bit.toString(),
                showarrow: false,
                font: { size: 12, color: bit === 1 ? 'green' : 'red' },
            })),
            textposition: 'top center',
        };

        const layoutDemodulated = {
            title: "FSK Demodulated Signal",
            xaxis: { title: "Time (s)" },
            yaxis: { title: "Amplitude" },
        };

        Plotly.newPlot("demodulated-plot", [traceDemodulated], layoutDemodulated);
    }


//const fs = 1000;
let Tb;
   let fc1, fc2;
    function sinc(x) {
      return x === 0 ? 1 : Math.sin(Math.PI * x) / (Math.PI * x);
    }

    function generateSpectrum(centerFreqs, label, color) {
      const f = Array.from({ length: 1000 }, (_, i) => -150 + i * 0.3);
      const y = f.map(freq => {
        return centerFreqs.reduce((acc, fc) => acc + Math.abs(sinc((freq - fc) * Tb)), 0);
      });
      return {
        x: f,
        y: y,
        name: label,
        line: { color },
        mode: 'lines'
      };
    }

    function generateSpectrumFSK() {
    Tb = 1/parseInt(document.getElementById("bit_rate").value);//1/bitRate;
    console.log(Tb);
    let A = 1;
    fc1 = parseInt(document.getElementById("carrier_frequency1").value);
    fc2 = parseInt(document.getElementById("carrier_frequency2").value);
    const fskSpec = generateSpectrum([fc1, fc2, -fc1, -fc2], 'FSK Spectrum', 'blue');

    Plotly.newPlot('frequencySpectrum', [fskSpec], {
      title: 'Spectra of FSK',
      xaxis: { title: 'Frequency (Hz)' },
      yaxis: { title: 'Amplitude', rangemode: 'tozero' }
    });
    document.getElementById('frequencySpectrum').scrollIntoView({ behavior: 'smooth' });
  }
  
function saveData() {
  const samplingFrequency = parseFloat(document.getElementById('sampling_frequency').value);
  const carrierFrequency = parseFloat(document.getElementById('carrier_frequency1').value);
  const carrierFrequency2 = parseFloat(document.getElementById('carrier_frequency2').value);
  const bitRate = parseFloat(document.getElementById('bit_rate').value);

  // Store as an object
  const myData = { 
    samplingFrequency: samplingFrequency, 
    carrierFrequency: carrierFrequency, 
    carrierFrequency2: carrierFrequency2,  
    bitRate: bitRate,                      
    modulated_signal: modulated_signal     
  };

  localStorage.setItem('sharedData', JSON.stringify(myData));
}

</script>

  <style>
  #demodulation {
  display: none;
  }
#container {
  background-color: #fff;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border-radius: 12px;
  padding: 25px 40px;
  max-width: 100%;
  margin: 20px auto;
  text-align: left;
  font-family: 'Segoe UI', sans-serif;
}

h1 {
  color: #1e3a8a;
  font-size: 24px;
  margin-bottom: 25px;
  text-align: justify;
}

ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}

li.step {
  margin: 12px 0;
  padding: 12px 15px;
  border-radius: 6px;
  font-size: 18px;
  font-weight: 500;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  transition: transform 0.2s ease, background-color 0.2s ease;
}

li.step::before {
  content: "✔";
  color: #10b981;
  margin-right: 10px;
  font-weight: bold;
}

li.step:hover {
  transform: scale(1.02);
  background-color: #f3f4f6;
}

/* Color code each step */
.step1 {
  background-color: #ffe0e0;
  border-left: 5px solid #ef4444;
}
.step2 {
  background-color: #e0f7ff;
  border-left: 5px solid #0ea5e9;
}
.step3 {
  background-color: #e0ffe5;
  border-left: 5px solid #22c55e;
}
.step4 {
  background-color: #f5e0ff;
  border-left: 5px solid #a855f7;
}
  </style>
  
</body>
</html>
